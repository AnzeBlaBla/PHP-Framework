<script>
    class Framework {
        static getRequestIdentifier() {
            return window.FrameworkData.requestIdentifier;
        }

        // This is a helper function to set innerHTML and execute scripts inside
        static setInnerHTML(elm, html) {
            elm.innerHTML = html;

            Array.from(elm.querySelectorAll("script"))
                .forEach(oldScriptEl => {
                    const newScriptEl = document.createElement("script");

                    Array.from(oldScriptEl.attributes).forEach(attr => {
                        newScriptEl.setAttribute(attr.name, attr.value)
                    });

                    const scriptText = document.createTextNode(oldScriptEl.innerHTML);
                    newScriptEl.appendChild(scriptText);

                    oldScriptEl.parentNode.replaceChild(newScriptEl, oldScriptEl);
                });
        }

        static getFormData(target) {
            const data = {};
            const elements = target.elements;
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                if (element.name !== '') {
                    data[element.name] = element.value;
                }
            }
            return data;
        }

        static async getComponent(componentPath, props = [], key = null) {
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getComponent',
                    componentPath: componentPath,
                    requestIdentifier: this.getRequestIdentifier(),
                    props: props,
                    key: key
                })
            });
            // determine if it's text or html
            const contentType = response.headers.get('content-type');
            let componentData;
            if (contentType.includes('application/json')) {
                componentData = await response.json();
            } else {
                componentData = await response.text();
            }

            return componentData;
        }

        static async renderComponent(target, componentPath, props = [], key = null) {
            const componentData = await this.getComponent(componentPath, props, key);

            // if target is a string, it's a query selector
            if (typeof target === 'string') {
                target = document.querySelector(target);
            } else if (target instanceof HTMLElement) {
                // do nothing
            } else {
                throw new Error('target must be a string or HTMLElement');
            }

            // if componentData is a string, it's html
            if (typeof componentData === 'string') {
                target.innerHTML = componentData;
            } else {
                // else it's json
                target.innerHTML = JSON.stringify(componentData);
            }
        }

    }
</script>